/**
 * 直播空间设计 Prompt 模板
 * 用于生成专业的AI图像编辑指令
 */

/**
 * 生成场景分析Prompt（步骤1：场景分析）
 * @returns {string} 场景分析Prompt字符串
 */
function generateSceneAnalysisPrompt() {
  const prompt = `你是专业的"室内空间分析专家"。请仔细分析这张房间照片，提供详细的分析报告。

**分析任务：**
1. **房间类型识别**：识别这是什么类型的房间（卧室、书房、工作室、直播间等）
2. **现有物品清单**：列出房间中所有可见的物品（大件家具、电子设备、装饰品等）
3. **布局分析**：描述房间的整体布局、空间利用情况
4. **杂乱物品识别（重点）**：仔细识别所有看起来杂乱、不整洁、不需要的物品，包括：
   - 散落的纸张、笔记本、文件
   - 多余的杯子、瓶子、容器
   - 临时放置的物品
   - 不协调的装饰品
   - 多余的杂物
   - 任何看起来杂乱、影响整洁的物品
5. **问题识别**：识别需要处理的问题，包括：
   - 明显的垃圾和杂物
   - 墙面上的贴纸、海报、装饰物
   - 桌面、地面、家具表面的污渍和脏痕
   - 散落的电线、数据线
   - 其他需要整理的问题
6. **改进建议**：基于分析结果，提供改进建议

**输出格式（重要）：**
请以结构化的方式输出分析结果，必须包括以下部分：

**【房间类型】**
[房间类型描述]

**【主要物品清单】**
[列出所有可见物品]

**【布局描述】**
[布局分析]

**【杂乱物品清单】（这是最重要的部分，必须详细列出）**
请详细列出所有看起来杂乱、不整洁、不需要的物品，并说明为什么它们被认为是杂乱的，例如：
- 散落的纸张、笔记本（位置不当、不整齐）
- 多余的杯子、瓶子（样式不协调、位置不当、多余）
- 临时放置的物品（不应该出现在这里）
- 不协调的装饰品（风格不匹配、多余）
- 其他杂乱物品
（如果某个物品看起来杂乱，即使它可能是功能性的，也要列出，并说明为什么它被认为是杂乱的）

**重要：** 对于每个杂乱物品，请说明：
1. 物品名称和位置
2. 为什么它被认为是杂乱的（位置不当、样式不协调、多余、不整洁等）
3. 物品类型（例如：水杯、瓶子、纸张等）

**【需要处理的问题】**
[问题列表]

**【改进建议】**
[改进建议]

**注意：** 
1. 只进行分析，不要修改图片
2. 【杂乱物品清单】必须详细、准确，这是后续清理步骤的重要依据
3. 如果某个物品看起来杂乱或影响整洁，即使它可能是功能性的，也要在杂乱物品清单中列出`;

  return prompt;
}

/**
 * 生成基础清理Prompt（步骤2：基础清理）
 * @param {string} clutterList - 从场景分析中提取的杂乱物品清单（可选）
 * @param {boolean} isRedo - 是否是重新清理（用户觉得清理不够，需要继续清理）
 * @returns {string} 基础清理Prompt字符串
 */
function generateBasicCleanupPrompt(clutterList = '', isRedo = false) {
  let clutterInstruction = '';
  if (clutterList && clutterList.trim() !== '') {
    clutterInstruction = `

**【重点清理清单】（基于场景分析识别出的杂乱物品）：**
${clutterList}

**重要：** 
1. 必须移除上述清单中的所有物品，这些物品已被识别为杂乱、不整洁、不协调的物品。
2. 移除这些物品后，后续步骤中不会重新添加相同或类似的杂乱物品。
3. 如果后续需要添加同类型物品，必须是整洁、协调、与环境搭配的新物品。`;
  }
  
  let redoInstruction = '';
  if (isRedo) {
    redoInstruction = `

**【重要：这是重新清理操作】**
用户点击了"重新清理"，说明之前的清理不够彻底，需要继续清理更多凌乱的东西。
请更仔细、更彻底地识别和移除所有凌乱、不整洁的物品，包括：
- 之前可能遗漏的小型杂物
- 位置不当的物品
- 不协调的装饰品
- 任何看起来杂乱、影响整洁的物品
- 桌面、地面、家具上的所有散落物品
请比之前清理得更彻底！`;
  }
  
  const prompt = `你是专业"房间基础清理师"。目标：移除房间中的明显垃圾和杂物。${clutterInstruction}${redoInstruction}

**【核心任务】移除以下明显垃圾和杂物：**
1. 地面上的垃圾、纸屑、塑料袋等明显垃圾
2. 散落在地上的物品（衣服、袋子、盒子等）
3. 明显不需要的杂物（空瓶子、废纸等）
4. 临时放置的物品
5. ${isRedo ? '【重新清理模式】更仔细地识别所有凌乱、不整洁的物品，包括之前可能遗漏的物品' : '其他明显不需要的物品'}

**【绝对禁止移除】**
1. 【绝对禁止移除】场景内现有的大显示器（无论大小、无论品牌）必须100%保留，绝对不能移除或替换。
2. 【绝对禁止移除】场景内现有的台式机主机、大型音箱等大型电子设备必须100%保留，绝对不能移除。
3. 【绝对禁止移除】现有的大件家具（桌子、椅子、柜子、床等）必须100%保留，绝对不能移除。
4. 【绝对禁止移除】所有功能性的物品都必须保留。

**【绝对禁止添加】**
- 任何新物品都不允许添加
- 只做清理工作，不添加任何东西

**要求：**
1. 保持房间原有布局和结构不变
2. 只移除明显垃圾，不要过度清理
3. 确保画面干净整洁`;

  return prompt;
}

/**
 * 生成深度整理Prompt（步骤3：深度整理 - 重点改进贴纸和污渍处理）
 * @param {string} clutterList - 从场景分析中提取的杂乱物品清单（可选）
 * @param {boolean} isRedo - 是否是重新整理（用户觉得整理不够，需要继续整理）
 * @returns {string} 深度整理Prompt字符串
 */
function generateDeepCleanupPrompt(clutterList = '', isRedo = false) {
  let clutterInstruction = '';
  if (clutterList && clutterList.trim() !== '') {
    clutterInstruction = `

**【已清理物品清单】（这些物品已在之前步骤清理）：**
${clutterList}

**重要规则：**
1. **禁止重新添加已清理的杂乱物品**：上述清单中的物品已被识别为杂乱、不协调的物品，绝对不允许以相同或类似的方式重新添加回来。

2. **允许添加同类型但整洁的新物品**：如果后续步骤需要添加同类型物品（例如水杯），必须是整洁、协调、与环境搭配的新物品，不能是之前清理掉的杂乱物品。`;
  }
  
  let redoInstruction = '';
  if (isRedo) {
    redoInstruction = `

**【重要：这是重新整理操作】**
用户点击了"重新整理"，说明之前的整理不够彻底，需要继续整理更多凌乱的东西。
请更仔细、更彻底地识别和清理所有细节问题，包括：
- 之前可能遗漏的贴纸、海报、装饰物
- 之前可能遗漏的污渍、脏痕
- 之前可能遗漏的小型杂物
- 任何看起来杂乱、影响整洁的物品
- 桌面、地面、家具上的所有散落物品
请比之前整理得更彻底！`;
  }
  
  const prompt = `你是专业"房间深度整理师"。目标：清理房间中的细节问题，特别是贴纸和污渍。${clutterInstruction}${redoInstruction}

**【核心任务】必须移除以下所有内容：**
1. 【必须移除】墙面上的所有贴纸、海报、装饰画、墙贴、贴纸、海报、装饰物、墙纸图案
2. 【必须移除】桌面、地面、家具表面的所有污渍、脏痕、污迹、污点、脏污、污垢、污斑
3. 【必须移除】所有散落的电线、数据线、充电线、电源线
4. 【必须移除】小型杂物、散落物品、多余的杯子、小板凳等
5. 【必须移除】墙上的脏痕、污渍、手印、脚印等
6. ${isRedo ? '【重新整理模式】更仔细地识别所有凌乱、不整洁的物品，包括之前可能遗漏的物品' : ''}

**【重点处理区域】**
- **墙面**：移除所有贴纸、海报、装饰物，保持墙面干净整洁
- **桌面**：清理所有污渍、脏痕，使桌面干净如新
- **地面**：清理所有污渍、脏痕，保持地面干净
- **家具表面**：清理所有污渍、脏痕，使家具表面干净

**【绝对禁止移除】**
1. 【绝对禁止移除】所有大件物品（显示器、主机、家具）必须100%保留
2. 【绝对禁止移除】所有功能性的物品都必须保留
3. 【绝对禁止移除】房间的整体结构和布局必须保持不变

**【绝对禁止添加】**
- 任何新物品都不允许添加
- 只做清理工作，不添加任何东西

**要求：**
1. 保持房间原有布局和结构完全不变
2. 保持房间原有的色彩基调（只清理污渍和贴纸，不改变整体颜色）
3. 确保所有表面干净整洁，无污渍、无贴纸
4. 画面干净、整洁、专业，符合极简美学`;

  return prompt;
}

/**
 * 生成布局优化Prompt（步骤4：布局优化）
 * @param {string} clutterList - 从场景分析中提取的杂乱物品清单（可选）
 * @returns {string} 布局优化Prompt字符串
 */
function generateLayoutOptimizePrompt(clutterList = '') {
  let clutterInstruction = '';
  if (clutterList && clutterList.trim() !== '') {
    clutterInstruction = `

**【已清理物品清单】（这些物品已被清理）：**
${clutterList}

**重要规则：**
1. **禁止重新添加已清理的杂乱物品**：上述清单中的物品已被识别为杂乱、不协调的物品，绝对不允许以相同或类似的方式重新添加回来。

2. **允许添加同类型但整洁的新物品**：如果后续步骤需要添加同类型物品，必须是整洁、协调、与环境搭配的新物品。`;
  }
  
  const prompt = `你是专业"空间布局优化师"。目标：优化房间的物品摆放，提升空间利用率和视觉效果。${clutterInstruction}

**【核心任务】优化物品布局：**
1. 调整物品位置，使空间利用更合理
2. 优化物品摆放，使画面更协调
3. 改善视觉平衡，使布局更专业
4. 优化物品间距，使空间更舒适

**【绝对禁止移除】**
1. 【绝对禁止移除】所有现有物品必须100%保留
2. 【绝对禁止移除】房间的整体结构必须保持不变

**【绝对禁止添加】**
- 任何新物品都不允许添加
- 只做位置调整，不添加任何东西

**【允许的操作】**
- 调整物品的位置和角度
- 优化物品的摆放方式
- 改善空间的视觉平衡
- 优化物品之间的间距

**要求：**
1. 保持所有物品完整，不丢失任何物品
2. 优化后的布局应该更专业、更协调
3. 保持房间原有的风格和色彩基调
4. 确保画面干净、整洁、专业`;

  return prompt;
}

/**
 * 生成添加道具Prompt（步骤5：添加道具 - 改进禁止规则）
 * @param {string} scenario - 直播类型/场景描述
 * @param {string} props - 用户指定的道具（可选，如果为空则AI自主选择）
 * @param {string} clutterList - 从场景分析中提取的杂乱物品清单（可选）
 * @returns {string} 完整的正面Prompt字符串
 */
function generateAddPropsPrompt(scenario, props = '', clutterList = '') {
  // 判断道具输入模式
  const hasSpecificProps = props && props.trim() !== '';
  const propsMode = hasSpecificProps ? 'B' : 'A';
  const propsDescription = hasSpecificProps 
    ? props.trim() 
    : '（留空，AI自主选择）';
  
  // 根据直播类型生成场景氛围描述
  const atmosphereDescription = `营造专业、宁静、专注的${scenario}氛围`;
  
  const prompt = `你是顶级"直播空间设计师"。目标：在已优化的房间基础上，添加适合${scenario}的专业道具。

**【核心原则】在保持房间现有布局和物品不变的基础上，添加合适的道具！**

**保留规则：**
1. 【绝对保留】保持房间现有布局和结构完全不变。
2. 【绝对保留】场景内所有现有的大显示器、主机、家具等必须100%保留，不能移除或替换。
3. 【绝对保留】保持房间原有的色彩基调和风格。

**道具决策规则：**
- **模式A(智能推断)**：若[用户指定的道具]为空，基于[场景氛围]自主添加 3-5 件最能体现主题的极简道具。
- **模式B(严格执行)**：若[用户指定的道具]非空，**必须**严格仅添加清单中物品，不多不少，不作任何额外添加。

**变量输入：**
【直播类型】：${scenario}
[场景氛围描述]：${atmosphereDescription}
[用户指定的道具]：${propsDescription}
**当前模式：** 模式${propsMode} ${hasSpecificProps ? '(严格执行用户指定道具)' : '(智能推断，自主选择3-5件道具)'}

**【严格禁止添加的物品类型】**
1. 【绝对禁止】任何电子设备（无论大小，包括音箱、音响、显示器、主机、电视、小音箱、蓝牙音箱、音响设备等）
2. 【绝对禁止】任何大件家具（桌子、椅子、柜子、床、沙发、书架等）
3. 【绝对禁止】任何装饰品、摆件、装饰物（除非用户明确指定）
4. 【绝对禁止】任何与${scenario}场景无关的物品
5. 【绝对禁止】任何用户未明确指定的物品（在模式B下）

**【允许添加的物品类型】**
- 用户明确指定的道具（模式B）- **如果用户指定了某个物品，即使该类型物品曾被清理，也可以添加，但必须是整洁、协调的新物品**
- 与${scenario}场景直接相关的专业道具（模式A），例如：
  - 书籍、笔记本、便签本
  - 台灯、阅读灯
  - 笔、文具
  - 专业相关的工具和道具
  - 符合场景氛围的小型道具

**添加物品的质量要求：**
1. 所有添加的物品必须是**全新的、整洁的、高品质的**
2. 必须与房间的整体风格和色彩协调
3. 必须位置合理，符合专业布局
4. 不能看起来廉价、临时或杂乱

**添加要求：**
1. 添加的道具必须符合极简美学，不能过于复杂或杂乱。
2. 道具摆放要专业、有序，符合${scenario}的场景需求。
3. 保持整体画面的干净、整洁、专业。
4. 使用专业"三点照明"原则优化光效。
5. 道具数量要适中，不要过多或过少。`;

  return prompt;
}

/**
 * 生成负面提示词（Negative Prompt）
 * @returns {string} 负面提示词字符串
 */
/**
 * 生成负面提示词（Negative Prompt）
 * @param {string} clutterList - 从场景分析中提取的杂乱物品清单（可选）
 * @returns {string} 负面提示词字符串
 */
function generateNegativePrompt(clutterList = '') {
  let clutterNegative = '';
  if (clutterList && clutterList.trim() !== '') {
    // 从杂乱物品清单中提取关键词添加到负面提示词
    clutterNegative = `, 已清理的杂乱物品, 重新添加的杂乱物品`;
  }
  
  return `低分辨率, 模糊, 噪点, 颗粒感, 畸变, 走形, 画面失焦, 压缩失真, 坏透视, 凌乱, 杂物堆积, 污渍, 脏乱差, 破旧, 垃圾, 乱扔的衣服, 过多复杂的图案, 过饱和的颜色, 廉价感, 业余打光, 刺眼强光, 夸张的阴影, 卡通, 动漫, 涂鸦, 油画, 浮夸, 不真实, 水印, 签名, 文本, 坏手, 坏肢体, 视角不正, 新添加的物品, 新添加的家具, 新添加的电子设备, 新添加的音箱, 新添加的装饰品, 新添加的道具, 移除显示器, 移除大显示器, 移除主机, 移除电脑, 移除家具, 移除桌子, 移除椅子, 移除大件物品${clutterNegative}.`;
}

// 导出函数
module.exports = {
  generateSceneAnalysisPrompt,
  generateBasicCleanupPrompt,
  generateDeepCleanupPrompt,
  generateLayoutOptimizePrompt,
  generateAddPropsPrompt,
  generateNegativePrompt
};
